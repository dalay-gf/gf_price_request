<?php

/**
 * Implements hook_menu().
 */
function gf_price_request_menu(){
  // Страница настроек модуля.
  $items['admin/config/gf-price-request'] = [
    'title' => 'GF: Price Requests',
    'description' => 'Settings for price change requests.',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['gf_price_request_settings_form'],
    'access arguments' => ['access administration pages'],
    'file' => 'gf_price_request.admin.inc',
  ];
  return $items;
}

function gf_price_request_theme() {
  return [
    'gf_price_request_mail' => [
      'template' => 'gf_price_request_mail',
      'variables' => [
        'node' => null,
        'percent' => null,
        'current_region' => null,
        'current_price' => null,
        'new_price' => null,
      ],
    ],
  ];
}

function gf_price_request_get_current_price($node) {
  $region = gf_stock_get_current_region();
  return (int) $node->gf_region_prices[$region];
}

function gf_price_request_node_view($node, $view_mode) {
  if ($view_mode == 'full' && uc_product_is_product($node->type)) {
    $form = '';
    if (user_access('price change prequest')){
      $form = drupal_get_form('gf_price_request_change_form', $node);
    }
    $node->content['gf_price_request_form'] = $form;
  }
}

function gf_price_request_change_form($form, &$form_state, $node) {
  $form['#node'] = $node;
  $form['#attributes']['class'][] = 'gf_price_request_form';

  $form['gf_price_request_price'] = [
    '#prefix' => '<div class="current-percent"></div><span class="gf-price-request minus">◄</span>',
    '#suffix' => '<span class="gf-price-request plus">►</span>',
    '#markup' => '<span class="price-box">' . gf_price_request_get_current_price($node) . '</span>',
  ];

  $form['gf_price_request_percent'] = ['#type' => 'textfield', '#default_value' => ''];
  $form['gf_price_request_percent']['#attributes']['class'][] = 'd-none';

  $form['submit'] = [
    '#prefix' => '<div class="submit-button-box">',
    '#suffix' => '</div>',
    '#type' => 'submit',
    '#value' => t('Ok'),
    '#attributes' => [
      'class' => [
        'd-none',
        'new-price-submit-button'
      ],
    ],
  ];


  $path = drupal_get_path('module', 'gf_price_request');
  $form['#attached']['css'][] = $path . '/gf_price_request.css';
  $form['#attached']['js'][] = $path . '/gf_price_request.js';

  return $form;
}

function gf_price_request_change_form_validate($form, &$form_state) {
  $percent = (int) $form_state['values']['gf_price_request_percent'];
  $to = variable_get('gf_price_request_recipient_addresses', '');
  if (empty($to)) {
    form_error($form, t('Request failed. In the settings there are no recipients for it.'));
  }
  elseif (100 < $percent || -100 > $percent){
    form_error($form, t('The number of percentages is not correct.'));
  }
}
function gf_price_request_change_form_submit($form, &$form_state) {
  $node = $form['#node'];
  $percent = $form_state['values']['gf_price_request_percent'];
  $region = gf_stock_get_current_region();
  $price = (int) $node->gf_region_prices[$region];
  $new_price = $price + (($price/100) * $percent);

  $to = variable_get('gf_price_request_recipient_addresses', '');

  if ($to) {
    $msg = theme('gf_price_request_mail', [
      'node' => $node,
      'percent' => $percent,
      'current_region' => $region,
      'current_price' => round($price),
      'new_price' => round($new_price),
    ]);
    $mail = [
      'subject' => t('Request for price change'),
      'message' => $msg,
    ];

    drupal_mail('system', 'mail', $to, language_default(), ['context' => $mail]);
  }
}

/**
 * Implements hook_permission()
 */
function gf_price_request_permission() {
  return array(
    'price change prequest' => array(
      'title' => t('Request for price change'),
      'description' => t('Permission to make a request to change the price of the product.'),
    ),
  );
}
